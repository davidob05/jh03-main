stages: [build, test]

variables:
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  GHCR_HOST: ghcr.io

build_with_kaniko:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: ["/busybox/sh", "-c"]
  script: |
    set -eu

    : "${GHCR_USERNAME:?Set GHCR_USERNAME to your GitHub username}"
    : "${GHCR_TOKEN:?Set GHCR_TOKEN (GitHub PAT with write:packages)}"

    GHCR_NAMESPACE="$GHCR_USERNAME"

    mkdir -p /kaniko/.docker
    printf '{"auths":{"%s":{"username":"%s","password":"%s"}}}\n' \
      "$GHCR_HOST" "$GHCR_USERNAME" "$GHCR_TOKEN" > /kaniko/.docker/config.json

    echo "Scanning services/* for Dockerfile(s)…"
    found=0
    for d in $(find services -mindepth 1 -maxdepth 1 -type d -print 2>/dev/null || true); do
      [ -f "$d/Dockerfile" ] || { echo "Skipping $(basename "$d"): no Dockerfile"; continue; }
      svc="$(basename "$d")"
      img="$(echo "$svc" | tr '[:upper:]' '[:lower:]')"
      dest_base="$GHCR_HOST/$GHCR_NAMESPACE/$img"
      echo "Building $svc -> $dest_base:$IMAGE_TAG"
      /kaniko/executor \
        --context "$CI_PROJECT_DIR/$d" \
        --dockerfile "$CI_PROJECT_DIR/$d/Dockerfile" \
        --destination "$dest_base:$IMAGE_TAG" \
        --destination "$dest_base:latest" \
        --cache \
        --cache-repo "$GHCR_HOST/$GHCR_NAMESPACE/cache"
      found=1
    done

    # <-- changed
    if [ "$found" -eq 0 ]; then
      echo "No services to build"
    fi

    echo "✅ Build job finished"

.test_job_template:
  stage: test
  # Use the Amazon ECR Public mirror of the official Node images (reliable from GitLab runners)
  image: public.ecr.aws/docker/library/node:20-alpine
  script:
    - set -eu
    - cd "$SERVICE_PATH"
    - if [ -f package-lock.json ]; then npm ci; else npm install; fi
    - npm test

test_frontend:
  extends: .test_job_template
  needs: ["build_with_kaniko"]
  variables:
    SERVICE_PATH: services/frontend/app

.django_test_template:
  stage: test
  # Mirror of the official Python image hosted on Amazon ECR Public
  image: public.ecr.aws/docker/library/python:3.12-slim
  services:
    - name: public.ecr.aws/docker/library/postgres:16-alpine
      alias: postgres
  variables:
    DJANGO_DB_NAME: postgres
    DJANGO_DB_USER: postgres
    DJANGO_DB_PASSWORD: postgres
    DJANGO_DB_HOST: postgres
    DJANGO_DB_PORT: "5432"
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
  script:
    - set -eu
    - cd "$SERVICE_PATH"
    - apt-get update
    - apt-get install -y --no-install-recommends build-essential gcc libffi-dev python3-dev
    - rm -rf /var/lib/apt/lists/*
    - python -m venv .venv
    - . .venv/bin/activate
    - pip install --upgrade pip
    - pip install --no-input -r requirements.txt
    - python - <<'PY'
        import os
        import time
        import psycopg

        dsn = "dbname={db} user={user} password={pwd} host={host} port={port}".format(
            db=os.getenv("DJANGO_DB_NAME", "postgres"),
            user=os.getenv("DJANGO_DB_USER", "postgres"),
            pwd=os.getenv("DJANGO_DB_PASSWORD", "postgres"),
            host=os.getenv("DJANGO_DB_HOST", "postgres"),
            port=os.getenv("DJANGO_DB_PORT", "5432"),
        )

        for attempt in range(30):
            try:
                with psycopg.connect(dsn, connect_timeout=1):
                    break
            except Exception as exc:
                print(f"Database not ready yet ({exc}); retrying...")
                time.sleep(1)
        else:
            raise SystemExit("Database not ready after waiting")
PY
    - python manage.py migrate --noinput
    - python manage.py test

test_django:
  extends: .django_test_template
  needs: ["build_with_kaniko"]
  variables:
    SERVICE_PATH: services/django/lithium
